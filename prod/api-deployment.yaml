apiVersion: apps/v1
kind: Deployment
metadata:
  name: wscs-api
  namespace: wscs
  labels:
    app: wscs-api
spec:
  replicas: 1
  selector:
    matchLabels:
      app: wscs-api
  template:
    metadata:
      labels:
        app: wscs-api
    spec:
      imagePullSecrets:
        - name: github-registry
      containers:
        - name: wscs-api
          image: ghcr.io/ptrrr/wscs-api:sha-2efd471
          ports:
            - containerPort: 3000
          env:
            # Port configuration
            - name: PORT
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: port

            # Database configuration
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: db-name
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: db-user
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: db-password
            - name: DATABASE_URI
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: db-uri

            # Payload/JWT configuration
            - name: PAYLOAD_SECRET
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: payload-secret

            - name: PAYLOAD_PUBLIC_STRIPE_IS_TEST_KEY
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: payload-public-stripe-is-test-key

            # Stripe configuration
            - name: STRIPE_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: stripe-secret-key
            - name: PUBLIC_STRIPE_KEY
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: stripe-public-key
            - name: STRIPE_WEBHOOKS_SIGNING_SECRET
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: stripe-webhooks-signing-secret

            # Revalidation configuration
            - name: REVALIDATION_KEY
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: revalidation-key

            # S3 configuration
            - name: S3_ENDPOINT
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: s3-endpoint
            - name: S3_BUCKET
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: s3-bucket
            - name: S3_REGION
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: s3-region
            - name: S3_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: s3-access-key-id
            - name: S3_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: s3-secret-access-key

            # SMTP configuration
            - name: SMTP_USER
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: smtp-user
            - name: SMTP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: smtp-password
            - name: SMTP_HOST
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: smtp-host
            - name: SMTP_PORT
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: smtp-port
            - name: SMTP_SECURE
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: smtp-secure

            # IMAP configuration
            - name: IMAP_HOST
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: imap-host
            - name: IMAP_USER
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: imap-user
            - name: IMAP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: imap-password

            # DHL configuration
            - name: DHL_USERNAME
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: dhl-username
            - name: DHL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: dhl-password
            - name: DHL_ACCOUNT_NUMBER
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: dhl-account-number

            # PostHog configuration
            - name: POSTHOG_API_KEY
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: posthog-api-key

            # OpenAI configuration
            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: api-secret
                  key: openai-api-key

            # Static environment variables
            - name: NODE_ENV
              value: "production"

            - name: APP_PUBLIC_SERVER_URL
              value: "https://ptrrr.space"
          resources:
            limits:
              cpu: 800m
              memory: 1.5Gi
            requests:
              cpu: 400m
              memory: 800Mi
          livenessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 30
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /api/health
              port: 3000
            initialDelaySeconds: 5
            periodSeconds: 10

---
apiVersion: v1
kind: Service
metadata:
  name: wscs-api-service
  namespace: wscs
  labels:
    app: wscs-api
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 3000
      protocol: TCP
  selector:
    app: wscs-api
